---
title: Spring的事务管理
layout: post
categories: J2EE
---

# Spring的事务管理

- **<font color = "red">什么是Spring的事务管理？</font>**
<br/>
&emsp;&emsp;在实际开发中，操作数据库时都会牵扯到事务管理问题，为此Spring提供了专门用于事务处理的API。Spring的事务管理简化了传统的事务管理流程，并且在一定程度上减少了开发者的工作量。

&emsp;&emsp;**事务管理的核心接口：**

<font color = "blue">1. Platform TransactionManager</font>

&emsp;&emsp;该接口提供了3个事务操作的方法，具体如下：

- TransactionStatus getTransaction(TransactionDefinition definition):用于获取事务状态的信息
- void commit(TransactionStatus  status):用于提交事务
- void rollback(TransactionStatus status):用于回滚事务

<font color = "blue">2. TransactionDefinition</font>

&emsp;&emsp;该接口提供了5个事务操作的方法，具体如下：

- String getName():获取事务对象名称
- int getIsolationLevel():获取事务的隔离级别
- int getPropagationBehavior():获取事务的传播行为
- int getTimeout():获取事务的超时时间
- boolean isReadOnly():获取事务是否只读

<font color = "blue">3. TransactionStatus</font>

&emsp;&emsp;该接口提供了6个事务操作的方法，具体如下：

- void flush():刷新事务
- boolean hasSavepoint():获取是否存在保存点
- boolean isCompleted():获取事务是否完成
- boolean isNewTransaction():获取是否为新事物
- boolean isRollbackOnly():获取事务是否回滚
- void setRollbackOnly():设置事务回滚

- **<font color = "red">Spring事务管理的方式？</font>**

1. 编程式事务管理

&emsp;&emsp;通过编写代码实现的事务管理，包括定义事务的开始、正常执行后的事务提交和异常是的事务回滚。

2. 声明式事务管理

&emsp;&emsp;通过AOP技术实现的事务管理，主要思想是将事务作为一个“切面”代码单独编写，然后通过AOP技术将事务管理的“切面”植入到业务目标类中。

# 编码

- 文件目录

运行下列代码时要先导入相应的jar包，版本也应该尽量匹配，避免因为版本问题导致代码运行出错。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200223105626265.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_0)

- Account类：

```java
public class Account {
	private Integer id;       // 账户id
	private String username; // 用户名
	private Double balance;  // 账户余额
	public Integer getId() {
		return id;
	}
	public void setId(Integer id) {
		this.id = id;
	}
	public String getUsername() {
		return username;
	}
	public void setUsername(String username) {
		this.username = username;
	}
	public Double getBalance() {
		return balance;
	}
	public void setBalance(Double balance) {
		this.balance = balance;
	}
	public String toString() {
		return "Account [id=" + id + ", "
				+ "username=" + username + 
				", balance=" + balance + "]";
	}
}

```

- AccountDao：

```java
package cn.ryan.jdbc;

import java.util.List;

public interface AccountDao {
	
	// 添加
	public int addAccount(Account account);
	
	// 更新
	public int updateAccount(Account account);
	
	// 删除
	public int deleteAccount(int id);
	
	// 通过id查询
	public Account findAccountById(int id);
	
	// 查询所有账户
	public List<Account> findAllAccount();
	
	// 转账
	public void transfer(String outUser,String inUser,double money);
}

```

- AccountDaoImpl

```java
import java.util.List;

import org.springframework.jdbc.core.BeanPropertyRowMapper;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.transaction.annotation.Isolation;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

public class AccountDaoImpl implements AccountDao {
	// 声明JdbcTemplate属性及其setter方法
	private JdbcTemplate jdbcTemplate;

	public void setJdbcTemplate(JdbcTemplate jdbcTemplate) {
		this.jdbcTemplate = jdbcTemplate;
	}

	// 添加账户
	public int addAccount(Account account) {
		// 定义SQL
		String sql = "insert into account(username,balance) value(?,?)";
		// 定义数组来存放SQL语句中的参数
		Object[] obj = new Object[] { account.getUsername(), account.getBalance() };
		// 执行添加操作，返回的是受SQL语句影响的记录条数
		int num = this.jdbcTemplate.update(sql, obj);
		return num;
	}

	// 更新账户
	public int updateAccount(Account account) {
		// 定义SQL
		String sql = "update account set username=?,balance=? where id = ?";
		// 定义数组来存放SQL语句中的参数
		Object[] params = new Object[] { account.getUsername(), account.getBalance(), account.getId() };
		// 执行添加操作，返回的是受SQL语句影响的记录条数
		int num = this.jdbcTemplate.update(sql, params);
		return num;
	}

	// 删除账户
	public int deleteAccount(int id) {
		// 定义SQL
		String sql = "delete  from account where id = ? ";
		// 执行添加操作，返回的是受SQL语句影响的记录条数
		int num = this.jdbcTemplate.update(sql, id);
		return num;
	}

	// 通过id查询账户数据信息
	public Account findAccountById(int id) {
		// 定义SQL语句
		String sql = "select * from account where id = ?";
		// 创建一个新的BeanPropertyRowMapper对象
		RowMapper<Account> rowMapper = new BeanPropertyRowMapper<Account>(Account.class);
		// 将id绑定到SQL语句中，并通过RowMapper返回一个Object类型的单行记录
		return this.jdbcTemplate.queryForObject(sql, rowMapper, id);
	}

	// 查询所有账户信息
	public List<Account> findAllAccount() {
		// 定义SQL语句
		String sql = "select * from account";
		// 创建一个新的BeanPropertyRowMapper对象
		RowMapper<Account> rowMapper = new BeanPropertyRowMapper<Account>(Account.class);
		// 执行静态的SQL查询，并通过RowMapper返回结果
		return this.jdbcTemplate.query(sql, rowMapper);
	}

	/**
	 *  转账
	 *  inUser：收款人
	 *  outUser：汇款人
	 *  money：收款金额
	*/
//	public void transfer(String outUser, String inUser, double money) {
//	    // 收款时，收款用户的余额=现有余额+所汇金额
//	    this.jdbcTemplate.update("update account set balance = balance +? "
//	            + "where username = ?",money, inUser);
//	    // 模拟系统运行时的突发性问题
//	    int i = 1/0;
//	    // 汇款时，汇款用户的余额=现有余额-所汇金额
//	    this.jdbcTemplate.update("update account set balance = balance-? "
//	            + "where username = ?",money, outUser);
//	}

//	@Transactional(propagation = Propagation.REQUIRED, 
//            isolation = Isolation.DEFAULT, readOnly = false)
	
	public void transfer(String outUser, String inUser, double money) {
	    // 收款时，收款用户的余额=现有余额+所汇金额
	    this.jdbcTemplate.update("update account set balance = balance +? "
	            + "where username = ?",money, inUser);
	    // 模拟系统运行时的突发性问题

	    // 汇款时，汇款用户的余额=现有余额-所汇金额
	    this.jdbcTemplate.update("update account set balance = balance-? "
	            + "where username = ?",money, outUser);
	}

}

```

- JdbcTemplateTest：

```java
import java.util.List;

import org.junit.Test;
import org.springframework.context.ApplicationContext;
import org.springframework.context.support.ClassPathXmlApplicationContext;
import org.springframework.jdbc.core.JdbcTemplate;

public class JdbcTemplateTest {
	/**
	 * 使用execute()方法建表
	 */
	/*
	 * public static void main(String[] args) { // 加载配置文件 ApplicationContext
	 * applicationContext = new
	 * ClassPathXmlApplicationContext("applicationContext.xml"); //
	 * 获取JdbcTemplate实例 JdbcTemplate jdTemplate = (JdbcTemplate)
	 * applicationContext.getBean("jdbcTemplate"); //
	 * 使用execute()方法执行SQL语句，创建用户账户管理表account jdTemplate.execute(
	 * "create table account(" + "id int primary key auto_increment," +
	 * "username varchar(50)," + "balance double)");
	 * System.out.println("账户表account创建成功！"); }
	 */

//	@Test
//	public void mainTest() {
//		// 加载配置文件
//		ApplicationContext applicationContext = new ClassPathXmlApplicationContext("applicationContext.xml");
//		// 获取JdbcTemplate实例
//		JdbcTemplate jdTemplate = (JdbcTemplate) applicationContext.getBean("jdbcTemplate");
//		// 使用execute()方法执行SQL语句，创建用户账户管理表account
//		jdTemplate.execute("create table account1(" + "id int primary key auto_increment," + "username varchar(50),"
//				+ "balance double)");
//		System.out.println("账户表account1创建成功！");
//	}

//	@Test
//	public void addAccountTest() {
//		// 加载配置文件
//		ApplicationContext applicationContext = new ClassPathXmlApplicationContext("applicationContext.xml");
//		// 获取AccountDao实例
//		AccountDao accountDao = (AccountDao) applicationContext.getBean("accountDao");
//		// 创建Account对象，并向Account对象中添加数据
//		Account account = new Account();
//		account.setUsername("tom");
//		account.setBalance(1000.00);
//		// 执行addAccount()方法，并获取返回结果
//		int num = accountDao.addAccount(account);
//		if (num > 0) {
//			System.out.println("成功插入了" + num + "条数据！");
//		} else {
//			System.out.println("插入操作执行失败！");
//		}
//	}
	
//	@Test
//	public void updateAccountTest() {
//	    // 加载配置文件
//	    ApplicationContext applicationContext = 
//	            new ClassPathXmlApplicationContext("applicationContext.xml");
//	    // 获取AccountDao实例
//	    AccountDao accountDao = 
//	            (AccountDao) applicationContext.getBean("accountDao");
//	    // 创建Account对象，并向Account对象中添加数据
//	    Account account = new Account();
//	    account.setId(1);
//	    account.setUsername("tom");
//	    account.setBalance(2000.00);
//	    // 执行updateAccount()方法，并获取返回结果
//	    int num = accountDao.updateAccount(account);
//	    if (num > 0) {
//	        System.out.println("成功修改了" + num + "条数据！");
//	    } else {
//	        System.out.println("修改操作执行失败！");
//	    }
//	}

	@Test
	public void deleteAccountTest() {
	    // 加载配置文件
	    ApplicationContext applicationContext = 
	            new ClassPathXmlApplicationContext("applicationContext.xml");
	    // 获取AccountDao实例
	    AccountDao accountDao = 
	            (AccountDao) applicationContext.getBean("accountDao");
	    // 执行deleteAccount()方法，并获取返回结果
	    int num = accountDao.deleteAccount(6);
	    if (num > 0) {
	        System.out.println("成功删除了" + num + "条数据！");
	    } else {
	        System.out.println("删除操作执行失败！");
	    }
	}
	
//	@Test
//	public void findAccountByIdTest() {
//	    // 加载配置文件
//	    ApplicationContext applicationContext = 
//	            new ClassPathXmlApplicationContext("applicationContext.xml");
//	    // 获取AccountDao实例
//	    AccountDao accountDao = 
//	            (AccountDao) applicationContext.getBean("accountDao");
//	    // 执行findAccountById()方法
//	    Account account = accountDao.findAccountById(1);
//	    System.out.println(account);
//	}
	
//	@Test
//	public void findAllAccountTest() {
//	    // 加载配置文件
//	    ApplicationContext applicationContext = 
//	            new ClassPathXmlApplicationContext("applicationContext.xml");
//	    // 获取AccountDao实例
//	    AccountDao accountDao = 
//	            (AccountDao) applicationContext.getBean("accountDao");
//	    // 执行findAllAccount()方法,获取Account对象的集合
//	    List<Account> account = accountDao.findAllAccount();
//	    // 循环输出集合中的对象
//	    for (Account act : account) {
//	        System.out.println(act);
//	    }
//	}



}

```

- TransactionTest：

```java
package cn.ryan.jdbc;

import org.junit.Test;
import org.springframework.context.ApplicationContext;
import 
org.springframework.context.support.ClassPathXmlApplicationContext;
//测试类
public class TransactionTest {
	@Test
	public void xmlTest(){
		ApplicationContext applicationContext = 
		   new ClassPathXmlApplicationContext("applicationContext.xml");
		// 获取AccountDao实例
		AccountDao accountDao = 
            (AccountDao)applicationContext.getBean("accountDao");
		// 调用实例中的转账方法
		accountDao.transfer("Jack", "Rose", 100.0);
	    // 输出提示信息
	    System.out.println("转账成功！");
	}
	 
//	@Test
//	public void annotationTest(){
//	    ApplicationContext applicationContext = 
//	new ClassPathXmlApplicationContext("applicationContext-annotation.xml");
//	    // 获取AccountDao实例
//	    AccountDao accountDao = 
//	(AccountDao)applicationContext.getBean("accountDao");
//	    // 调用实例中的转账方法
//	    accountDao.transfer("Jack", "Rose", 0);
//	    // 输出提示信息
//	    System.out.println(accountDao.findAllAccount());
//	    System.out.println("转账成功！");
//	}

}

```

- applicationContext-annotation.xml：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
    xmlns:aop="http://www.springframework.org/schema/aop"
    xmlns:tx="http://www.springframework.org/schema/tx" 
    xmlns:context="http://www.springframework.org/schema/context"
    xsi:schemaLocation="http://www.springframework.org/schema/beans 
    http://www.springframework.org/schema/beans/spring-beans-4.3.xsd
    http://www.springframework.org/schema/tx 
    http://www.springframework.org/schema/tx/spring-tx-4.3.xsd
    http://www.springframework.org/schema/context 
    http://www.springframework.org/schema/context/spring-context-4.3.xsd
    http://www.springframework.org/schema/aop 
    http://www.springframework.org/schema/aop/spring-aop-4.3.xsd">
    <!-- 1.配置数据源 -->
    <bean id="dataSource" 
    class="org.springframework.jdbc.datasource.DriverManagerDataSource">
		<!--数据库驱动 -->
		<property name="driverClassName" value="com.mysql.cj.jdbc.Driver" />
		<!--连接数据库的url -->
		<property name="url" value="jdbc:mysql://localhost/spring?serverTimezone=UTC" />
		<!--连接数据库的用户名 -->
		<property name="username" value="root" />
		<!--连接数据库的密码 -->
		<property name="password" value="root" />
	</bean>
	<!-- 2.配置JDBC模板 -->
	<bean id="jdbcTemplate" 
            class="org.springframework.jdbc.core.JdbcTemplate">
		<!-- 默认必须使用数据源 -->
		<property name="dataSource" ref="dataSource" />
	</bean>
	<!--3.定义id为accountDao的Bean -->
	<bean id="accountDao" class="cn.ryan.jdbc.AccountDaoImpl">
		<!-- 将jdbcTemplate注入到AccountDao实例中 -->
		<property name="jdbcTemplate" ref="jdbcTemplate" />
	</bean>
	<!-- 4.事务管理器，依赖于数据源 -->
	<bean id="transactionManager" class=
     "org.springframework.jdbc.datasource.DataSourceTransactionManager">
		<property name="dataSource" ref="dataSource" />
	</bean>	
    <!-- 5.注册事务管理器驱动 -->
	<tx:annotation-driven transaction-manager="transactionManager"/>
</beans>

```

- applicationContext.xml:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
    xmlns:aop="http://www.springframework.org/schema/aop"
    xmlns:tx="http://www.springframework.org/schema/tx" 
    xmlns:context="http://www.springframework.org/schema/context"
    xsi:schemaLocation="http://www.springframework.org/schema/beans 
    http://www.springframework.org/schema/beans/spring-beans-4.3.xsd
    http://www.springframework.org/schema/tx 
    http://www.springframework.org/schema/tx/spring-tx-4.3.xsd
    http://www.springframework.org/schema/context 
    http://www.springframework.org/schema/context/spring-context-4.3.xsd
    http://www.springframework.org/schema/aop 
    http://www.springframework.org/schema/aop/spring-aop-4.3.xsd">
    <!-- 1.配置数据源 -->
    <bean id="dataSource" 
    class="org.springframework.jdbc.datasource.DriverManagerDataSource">
		<!--数据库驱动 -->
		<property name="driverClassName" value="com.mysql.cj.jdbc.Driver" />
		<!--连接数据库的url -->
		<property name="url" value="jdbc:mysql://localhost:3306/spring?serverTimezone=UTC" />
		<!--连接数据库的用户名 -->
		<property name="username" value="root" />
		<!--连接数据库的密码 -->
		<property name="password" value="root" />
   </bean>
   <!-- 2.配置JDBC模板 -->
   <bean id="jdbcTemplate" 
          class="org.springframework.jdbc.core.JdbcTemplate">
		 <!-- 默认必须使用数据源 -->
		 <property name="dataSource" ref="dataSource" />
   </bean>
   <!--3.定义id为accountDao的Bean -->
   <bean id="accountDao" class="cn.ryan.jdbc.AccountDaoImpl">
		 <!-- 将jdbcTemplate注入到AccountDao实例中 -->
		 <property name="jdbcTemplate" ref="jdbcTemplate" />
   </bean>	
   <!-- 4.事务管理器，依赖于数据源 -->
   <bean id="transactionManager" class=
   "org.springframework.jdbc.datasource.DataSourceTransactionManager">
		<property name="dataSource" ref="dataSource" />
   </bean>	
   <!-- 5.编写通知：对事务进行增强(通知),需要编写对切入点和具体执行事务细节 -->
   <tx:advice id="txAdvice" transaction-manager="transactionManager">
		<tx:attributes>
			<!-- name：*表示任意方法名称 -->
			<tx:method name="*" propagation="REQUIRED" 
                           isolation="DEFAULT" read-only="false" />
		</tx:attributes>
	</tx:advice>
	<!-- 6.编写aop，让spring自动对目标生成代理，需要使用AspectJ的表达式 -->
	<aop:config>
		<!-- 切入点 -->
		<aop:pointcut expression="execution(* cn.ryan.jdbc.*.*(..))"
			id="txPointCut" />
		<!-- 切面：将切入点与通知整合 -->
		<aop:advisor advice-ref="txAdvice" pointcut-ref="txPointCut" />
	</aop:config>
</beans>

```

# 声明式事务管理

- 建表
![建表](https://img-blog.csdnimg.cn/20200223110106127.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_0)
- 插入数据
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200223111242832.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_0)
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200223111455805.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_0)
- 修改数据

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200223111559783.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_0)![在这里插入图片描述](https://img-blog.csdnimg.cn/2020022311161039.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_0)

- 删除

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200223111741791.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_16,color_FFFFFF,t_0)
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200223111753820.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_0)

- 转账

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200223112225613.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_0)

# 编程式事务管理

- 转账

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200223112305319.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_0)
![在这里插入图片描述](https://img-blog.csdnimg.cn/2020022311240193.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_0)
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200223112532376.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_0)




---
---
**欢迎查看我的CSDN博客：[Welcome To Ryan's Home](https://blog.csdn.net/qq_41422448)**

---
---