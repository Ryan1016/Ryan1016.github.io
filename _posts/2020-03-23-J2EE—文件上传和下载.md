---
title: 文件上传和下载
layout: post
categories: J2EE
---


## 一、文件上传
&emsp;&emsp;多数文件上传都是通过表单形式提交给后台服务器的，因此，要实现文件上传功能，就需要提供一个文件上传的表单，而该表单必须满足以下3个条件：

①form表单的method属性设置为post；

②form表单的enctype属性设置为multipart/form-data；

③提供`<input type="file" name="filename" />`的文件上传输入框。

**文件上传示例如下：**
```xml
<form action="uploadUrl" method="post" enctype="multipart/form-data">
<!--multiple属性是HTML5中新属性，可实现多文件上传-->
	<input type="file" name="filename" multiple="multiple" /> <input
		type="submit" value="文件上传" />
</form>
```

&emsp;&emsp;当form表单的enctype属性为multipart/form-data时，浏览器就会采用二进制流来处理表单数据，服务器端就会对文件上传的请求进行解析处理。Spring MVC通过MultipartResolver实现文件上传功能。MultipartResolver是一个接口对象，需要通过它的实现类CommonsMultipartResolver来完成文件上传工作。

**MultipartResolver配置示例如下：**
```xml
     <bean id="multipartResolver"          	     
            class="org.springframework.web.multipart.commons.CommonsMultipartResolver">
            <!--设置请求编码格式，必须与JSP中的pageEncoding属性一致，默认为ISO-8859-1-->
             <property name="defaultEncoding" value="UTF-8" />
             <!--设置允许上传文件的最大值（2M），单位为字节-->
             <property name="maxUploadSize" value="2097152" />
             ...
     </bean>
```

&emsp;&emsp;在前面的配置代码中，除配置了CommonsMultipartResolver类外，还通过`<property>`元素配置了编码格式以及允许上传文件的大小。通过`<property>`元素可以对文件解析器类CommonsMultipartResolver的如下属性进行配置：

- maxUploadSize：上传文件最大长度（以字节为单位）；

- maxInMemorySize：缓存中的最大尺寸；

- defaultEncoding：默认编码格式；

- resolveLazily：推迟文件解析，以便在Controller中捕获文件大小异常。

**Tips：** 因为MultipartResolver接口的实现类CommonsMultipartResolver内部是引用multipartResolver字符串获取该实现类对象并完成文件解析的，所以在配置CommonsMultipartResolver时必须指定该Bean的id为multipartResolver。


&emsp;&emsp;当完成页面表单和文件上传解析器的配置后，在Controller中编写文件上传的方法即可实现文件上传，其代码如下所示：
```java
@Controller
public class FileUploadController {
      @RequestMapping("/fileUpload ")
      public String handleFormUpload(@RequestParam("name") String name,
                                                               @RequestParam("filename") MultipartFile file,...) {
if (!file.isEmpty()) {
	...
	return "uploadSuccess";
}
return "uploadFailure";
           }
    }
```


&emsp;&emsp;在上述代码中，包含一个MultipartFile接口类型的参数file，上传到程序中的文件是被封装在该参数中的。

&emsp;&emsp;org.springframework.web.multipart.MultipartFile接口中提供了获取上传文件、文件名称等方法，如下表所示：
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200323122045747.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_70)

## 二、文件下载

&emsp;&emsp;文件下载就是将文件服务器中的文件下载到本机上。在Spring MVC环境中，实现文件下载大致可分为如下两个步骤：
1. 在客户端页面使用一个文件下载的超链接，该链接的href属性要指定后台文件下载的方法以及文件名（需要先在文件下载目录中添加了一个名称为“1.jpg”的文件）。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200323134157886.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_0)
```html
<a href="${pageContext.request.contextPath }/download?filename=1.jpg"> 文件下载 </a>
```

2. 在后台使用Spring MVC提供的ResponseEntity类型对象完成文件下载，使用它可以很方便的定义返回的HttpHeaders对象和HttpStatus对象，通过对这两个对象的设置，即可完成下载文件时所需的配置信息。
```java
 public ResponseEntity<byte[]> fileDownload(HttpServletRequest request,
                                                                       String filename) throws Exception{
      String path = request.getServletContext().getRealPath("/upload/");
      File file = new File(path+File.separator+filename);
      HttpHeaders headers = new HttpHeaders();
      headers.setContentDispositionFormData("attachment", filename);
      headers.setContentType(MediaType.APPLICATION_OCTET_STREAM);
return new ResponseEntity<byte[]>(FileUtils.readFileToByteArray(file),headers,HttpStatus.OK);
}
```
&emsp;&emsp;当对中文名文件下载下载时，因为各个浏览器内部转码机制的不同，就会出现不同的乱码以及解析异常问题。为了解决浏览器中文件下载时中文名称的乱码问题，可以在前端页面发送请求前先对中文名进行统一编码，然后在后台控制器类中对文件名称进行相应的转码。
```js
  <%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
  <%@page import="java.net.URLEncoder"%>
  ...
  <body>
      <a href="${pageContext.request.contextPath }/download?filename=<%=URLEncoder.encode(“ 
        壁纸.jpg", "UTF-8")%>">
	中文名称文件下载 </a>
    </body>
</html>
```

## 三、运行结果
**上传文件：**
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200323133719327.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_70)
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200323133749884.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_70)

**下载文件：**
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200323133615636.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_70)
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200323133640142.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_70)


<br/><br/>

---
**<font color="red">最后的最后，欢迎查看我的CSDN博客：</font>[Welcome To Ryan's Home](https://blog.csdn.net/qq_41422448/article/details/105045667)**

---