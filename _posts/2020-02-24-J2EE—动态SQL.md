---
title: 动态SQL
layout: post
categories: J2EE
---




## 动态SQL有什么用？
&emsp;&emsp;开发人员在使用JDBC或其他类似的框架进行数据库开发时，通常都要根据需求去手动拼装SQL，这是一个非常麻烦且痛苦的工作，而MyBatis提供的对SQL语句动态组装的功能，恰能很好的解决这一麻烦工作。

## 动态SQL中的元素

![动态SQL元素](https://img-blog.csdnimg.cn/20200224202128120.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_0)




- **if元素**

&emsp;&emsp;if元素是最常用的判断语句，它类似于Java中的if语句，主要用于实现某些简单的条件选择。其基本使用示例如下：

```xml
select * from t_customer where 1=1 
     <if test="username !=null and username !=''">
	and username like concat('%',#{username}, '%')
     </if>
     <if test="jobs !=null and jobs !=''">
	and jobs= #{jobs}
     </if>
```

- **choose及其子元素**

&emsp;&emsp;choose、when、otherwise元素：

```xml
select * from t_customer where 1=1
	<choose>
     	<when test="username !=null and username !=''">
                 and username like concat('%',#{username}, '%')
    	 </when>
    	 <when test="jobs !=null and jobs !=''">
                 and jobs= #{jobs}
    	 </when>
    	 <otherwise>
             and phone is not null
   		 </otherwise>
	</choose>
```

- **when、trim元素**

&emsp;&emsp;前面的举例种，映射文件中编写的SQL后面都加入了“where 1=1”的条件，那么到底为什么要这么写呢？如果将where后“1=1”的条件去掉，那么MyBatis所拼接出来的SQL将会如下所示：
    
    select * from t_customer where and username like concat('%',?, '%')

&emsp;&emsp;可以看出上面SQL语句明显存在SQL语法错误，而加入了条件“1=1”后，既保证了where后面的条件成立，又避免了where后面第一个词是and或者or之类的关键词。不过“where 1=1”这种写法对于初学者来将不容易理解，并且也不够雅观。
&emsp;&emsp;针对上述情况中“where 1=1”，在MyBatis的SQL中就可以使用where或trim元素进行动态处理。

```xml
select * from t_customer
<trim prefix="where" prefixOverrides="and">
       <if test="username !=null and username !=''">
             and username like concat('%',#{username}, '%')
       </if>
       <if test="jobs !=null and jobs !=''">
             and jobs= #{jobs}
       </if>
</trim>
```

**<font color = "red">Tips:</font>where会自动判断SQL语句，只有<where>内的条件成立时，才会在拼接SQL中加入where关键字，否则将不会添加；还会去除多余的“AND”或“OR”。**



**动态SQL处理：**

```xml
select * from t_customer
<where>
     <if test="username !=null and username !=''">
           and username like concat('%',#{username}, '%')
     </if>
     <if test="jobs !=null and jobs !=''">
           and jobs= #{jobs}
     </if>
</where>
```


- **set元素**

&emsp;&emsp;在Hibernate中，想要更新某个对象，就需要发送所有的字段给持久化对象，这种想更新的每一条数据都要将其所有的属性都更新一遍的方法，其执行效率是非常差的。为此，在MyBatis中可以使用动态SQL中的<set>元素进行处理：

```xml
<update id="updateCustomer"  parameterType="com.itheima.po.Customer">
        update t_customer 
        <set>
            <if test="username !=null and username !=''">
                  username=#{username},
            </if>
            <if test="jobs !=null and jobs !=''">
                  jobs=#{jobs},
            </if>
        </set>
        where id=#{id}
</update>
```

**<font color = "red">Tips:</font> 使用<set>和<if>元素对username和jobs进行更新判断，并动态组装SQL。这样就只需要传入想要更新的字段即可。**


- **foreach元素**

&emsp;&emsp; 在一个客户表中有1000条数据，现在需要将id值小于100的客户信息全部查询出来，这要怎么做呢？
&emsp;&emsp; 针对上述需求，理想的解决方法就是使用MyBatis中动态SQL的foreach元素进行处理。其基本使用示例如下所示：

```xml
<select id="findCustomerByIds" parameterType="List"
                         resultType="com.itheima.po.Customer">
           select * from t_customer where id in
            <foreach item="id" index="index" collection="list" 
                            open="(" separator="," close=")">
                   #{id}
            </foreach>
</select>

```
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200224204042778.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_0)**<font color="red"> Tips:</font>** 在使用<foreach>时最关键也是最容易出错的就是collection属性，该属性是必须指定的，而且在不同情况下，该属性的值是不一样的。主要有以下3种情况：

1. 如果传入的是单参数且参数类型是一个数组或者List的时候，collection属性值分别为array和list（或collection）。
2. 如果传入的参数是多个的时候，就需要把它们封装成一个Map了，当然单参数也可以封装成Map集合，这时候collection属性值就为Map的键。
3. 如果传入的参数是POJO包装类的时候，collection属性值就为该包装类中需要进行遍历的数组或集合的属性名。https://editor.csdn.net/md?articleId=104480397

- ** bind  元素**

>select * from t_customer where username like '%${value}%'

上述SQL语句有什么不妥？
1. 如果使用“${}”进行字符串拼接，则无法防止SQL注入问题；
2. 如果改用concat函数进行拼接，则只针对MySQL数据库有效；
3. 如果改用“||”进行字符串拼接，则只针对Oracle数据库有效。

&emsp;&emsp; MyBatis的<bind>元素可以通过OGNL表达式来创建一个上下文变量，其使用方式如下：

```xml
<select id="findCustomerByName" parameterType="com.itheima.po.Customer"
                 resultType="com.itheima.po.Customer">
	<bind name="pattern_username" value="'%'+_parameter.getUsername()+'%'" />
       select * from t_customer 
       where username like #{pattern_username}
</select>
```


## 工程目录
![工程目录](https://img-blog.csdnimg.cn/20200301152502468.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_0)
## 演示代码
**Customer：**
```java
package com.ryan.po;
/**
 * 客户持久化类
 */
public class Customer {
	private Integer id;       // 主键id
	private String username; // 客户名称
	private String jobs;      // 职业
	private String phone;     // 电话
	public Integer getId() {
		return id;
	}
	public void setId(Integer id) {
		this.id = id;
	}
	public String getUsername() {
		return username;
	}
	public void setUsername(String username) {
		this.username = username;
	}
	public String getJobs() {
		return jobs;
	}
	public void setJobs(String jobs) {
		this.jobs = jobs;
	}
	public String getPhone() {
		return phone;
	}
	public void setPhone(String phone) {
		this.phone = phone;
	}
	@Override
	public String toString() {
		return "Customer [id=" + id + ", username=" + username + 
				       ", jobs=" + jobs + ", phone=" + phone + "]";
	}
}

```

**MybatisUtils：**
```java
package com.ryan.utils;
import java.io.Reader;
import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;
/**
 * 工具类
 */
public class MybatisUtils {
	private static SqlSessionFactory sqlSessionFactory = null;
	// 初始化SqlSessionFactory对象
	static {
		try {
			// 使用MyBatis提供的Resources类加载mybatis的配置文件
			Reader reader = 
					Resources.getResourceAsReader("mybatis-config.xml");
			// 构建sqlSession的工厂
			sqlSessionFactory = 
					new SqlSessionFactoryBuilder().build(reader);
		} catch (Exception e) {
			e.printStackTrace();
		}
	}
	// 获取SqlSession对象的静态方法
	public static SqlSession getSession() {
		return sqlSessionFactory.openSession();
	}
}
```

**MybatisTest：**
```java
package com.ryan.test;
import java.util.ArrayList;
import java.util.List;
import org.apache.ibatis.session.SqlSession;
import org.junit.Test;
import com.ryan.po.Customer;
import com.ryan.utils.MybatisUtils;
public class MybatisTest {
	/**
	 * 根据客户姓名和职业组合条件查询客户信息列表
	 */
	@Test
	public void findCustomerByNameAndJobsTest(){
		// 通过工具类生成SqlSession对象
		SqlSession session = MybatisUtils.getSession();
		// 创建Customer对象，封装需要组合查询的条件
		Customer customer = new Customer();
		customer.setUsername("jack");
//		customer.setJobs("teacher");
		// 执行SqlSession的查询方法，返回结果集
	   List<Customer> customers = session.selectList("com.ryan.mapper" 
		       + ".CustomerMapper.findCustomerByNameAndJobs",customer);
		// 输出查询结果信息
		for (Customer customer2 : customers) {
			// 打印输出结果
			System.out.println(customer2);
		}
		// 关闭SqlSession
		session.close();
	}
	
	/**
	 * 根据客户姓名或职业查询客户信息列表
	 */
	@Test
	public void findCustomerByNameOrJobsTest(){
	    // 通过工具类生成SqlSession对象
	    SqlSession session = MybatisUtils.getSession();
	    // 创建Customer对象，封装需要组合查询的条件
	    Customer customer = new Customer();
//	    customer.setUsername("jack");
//	    customer.setJobs("teacher");
	    // 执行SqlSession的查询方法，返回结果集
	    List<Customer> customers = session.selectList("com.ryan.mapper" 
	            + ".CustomerMapper.findCustomerByNameOrJobs",customer);
	    // 输出查询结果信息
	    for (Customer customer2 : customers) {
	        // 打印输出结果
	        System.out.println(customer2);
	    }
	    // 关闭SqlSession
	    session.close();
	}

	/**
	 * 更新客户
	 */
	@Test
	public void updateCustomerTest() {		
	    // 获取SqlSession
	    SqlSession sqlSession = MybatisUtils.getSession();
	    // 创建Customer对象，并向对象中添加数据
	    Customer customer = new Customer();
	    customer.setId(3);
	    customer.setPhone("13311111234");
	    // 执行SqlSession的更新方法，返回的是SQL语句影响的行数
	    int rows = sqlSession.update("com.ryan.mapper"
	            + ".CustomerMapper.updateCustomer", customer);
	    // 通过返回结果判断更新操作是否执行成功
	    if(rows > 0){
	        System.out.println("您成功修改了"+rows+"条数据！");
	    }else{
	        System.out.println("执行修改操作失败！！！");
	    }
	    // 提交事务
	    sqlSession.commit();
	    // 关闭SqlSession
	    sqlSession.close();
	}
	
	/**
	 * 根据客户编号批量查询客户信息
	 */
	@Test
	public void findCustomerByIdsTest(){
	    // 获取SqlSession
	    SqlSession session = MybatisUtils.getSession();
	    // 创建List集合，封装查询id
	    List<Integer> ids=new ArrayList<Integer>();
	    ids.add(1);
	    ids.add(2);
	    // 执行SqlSession的查询方法，返回结果集
	    List<Customer> customers = session.selectList("com.ryan.mapper"
	            + ".CustomerMapper.findCustomerByIds", ids);
	    // 输出查询结果信息	
	    for (Customer customer : customers) {
	        // 打印输出结果
	        System.out.println(customer);
	    }
	    // 关闭SqlSession
	    session.close();
	}

	/**
	 * bind元素的使用：根据客户名模糊查询客户信息 
	 */
	@Test
	public void findCustomerByNameTest(){
	    // 通过工具类生成SqlSession对象
	    SqlSession session = MybatisUtils.getSession();
	    // 创建Customer对象，封装查询的条件
	    Customer customer =new Customer();
	    customer.setUsername("j");
	    // 执行sqlSession的查询方法，返回结果集
	    List<Customer> customers = session.selectList("com.ryan.mapper"
	            + ".CustomerMapper.findCustomerByName", customer);
	    // 输出查询结果信息	
	    for (Customer customer2 : customers) {
	        // 打印输出结果
	        System.out.println(customer2);
	    }
	    // 关闭SqlSession
	    session.close();
	}

}

```

**CustomerMapper.xml：**
```java
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ryan.mapper.CustomerMapper">
	<!-- <if>元素使用 -->
<!-- 	<select id="findCustomerByNameAndJobs" parameterType="com.ryan.po.Customer" 
										   resultType="com.ryan.po.Customer"> 
		select * from t_customer where 1=1 
		<if test="username !=null and username !=''"> 
			and username like concat('%',#{username},'%') 
		</if> <if test="jobs !=null and jobs !=''"> 
			and jobs= #{jobs} 
		</if> 
	</select> -->
	<!-- <where>元素 -->
<!-- 	<select id="findCustomerByNameAndJobs" parameterType="com.ryan.po.Customer" 
											resultType="com.ryan.po.Customer"> 
		select * from t_customer 
		<where> 
		<if test="username !=null and username !=''"> 
			and username like concat('%',#{username},'%') 
		</if> 
		<if test="jobs !=null and jobs !=''"> 
			and jobs= #{jobs} 
		</if> 
		</where> 
	</select> -->
	<!-- <trim>元素 -->
	<select id="findCustomerByNameAndJobs" parameterType="com.ryan.po.Customer"
		resultType="com.ryan.po.Customer">
		select * from t_customer
		<trim prefix="where" prefixOverrides="and">
			<if test="username !=null and username !=''">
				and username like concat('%',#{username}, '%')
			</if>
			<if test="jobs !=null and jobs !=''">
				and jobs= #{jobs}
			</if>
		</trim>
	</select>

	<!--<choose>(<when>、<otherwise>)元素使用 -->
	<select id="findCustomerByNameOrJobs" parameterType="com.ryan.po.Customer"
		resultType="com.ryan.po.Customer">
		select * from t_customer where 1=1
		<choose>
			<when test="username !=null and username !=''">
				and username like concat('%',#{username}, '%')
			</when>
			<when test="jobs !=null and jobs !=''">
				and jobs= #{jobs}
			</when>
			<otherwise>
				and phone is not null
			</otherwise>
		</choose>
	</select>

	<!-- <set>元素 -->
	<update id="updateCustomer" parameterType="com.ryan.po.Customer">
		update t_customer
		<set>
			<if test="username !=null and username !=''">
				username=#{username},
			</if>
			<if test="jobs !=null and jobs !=''">
				jobs=#{jobs},
			</if>
			<if test="phone !=null and phone !=''">
				phone=#{phone},
			</if>
		</set>
		where id=#{id}
	</update>

	<!--<foreach>元素使用 -->
	<select id="findCustomerByIds" parameterType="List"
		resultType="com.ryan.po.Customer">
		select * from t_customer where id in
		<foreach item="id" index="index" collection="list" open="("
			separator="," close=")">
			#{id}
		</foreach>
	</select>

	<!--<bind>元素的使用：根据客户名模糊查询客户信息 -->
	<select id="findCustomerByName" parameterType="com.ryan.po.Customer"
		resultType="com.ryan.po.Customer">
		<!--_parameter.getUsername()也可直接写成传入的字段属性名，即username -->
		<bind name="pattern_username" value="'%'+_parameter.getUsername()+'%'" />
		select * from t_customer
		where
		username like #{pattern_username}
	</select>

</mapper>

```

**db.propertites：**
```propertites
jdbc.driver=com.mysql.cj.jdbc.Driver
jdbc.url=jdbc:mysql://localhost:3306/mybatis?serverTimezone=UTC
jdbc.username=root
jdbc.password=root

```
**log4j.propertites：**
```java
# Global logging configuration
log4j.rootLogger=ERROR, stdout
# MyBatis logging configuration...
log4j.logger.com.ryan=DEBUG
# Console output...
log4j.appender.stdout=org.apache.log4j.ConsoleAppender
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
log4j.appender.stdout.layout.ConversionPattern=%5p [%t] - %m%n

```
**mybatis-config.xml：**
```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
	<properties resource="db.properties" />
	<!--1.配置环境 ，默认的环境id为mysql -->
	<environments default="mysql">
		<!--1.2.配置id为mysql的数据库环境 -->
		<environment id="mysql">
			<!-- 使用JDBC的事务管理 -->
			<transactionManager type="JDBC" />
			<!--数据库连接池 -->
			<dataSource type="POOLED">
				<!-- 数据库驱动 -->
				<property name="driver" value="${jdbc.driver}" />
				<!-- 连接数据库的url -->
				<property name="url" value="${jdbc.url}" />
				<!-- 连接数据库的用户名 -->
				<property name="username" value="${jdbc.username}" />
				<!-- 连接数据库的密码 -->
				<property name="password" value="${jdbc.password}" />
			</dataSource>
		</environment>
	</environments>
	<!--2.配置Mapper的位置 -->
	<mappers>
		<mapper resource="com/ryan/mapper/CustomerMapper.xml" />
	</mappers>
</configuration>

```
## 运行结果
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200301160205235.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxNDIyNDQ4,size_1,color_FFFFFF,t_0)